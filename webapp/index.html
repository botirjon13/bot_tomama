<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Tomama 2026</title>

  <!-- Telegram SDK (HEAD ichida bo‚Äòlsin) -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <script>
    window.SERVER_URL = "https://oyinbackent-production.up.railway.app";
  </script>

  <link rel="stylesheet" href="style.css">

  <style>
    .avatar-img { width: 36px; height: 36px; border-radius: 50%; border: 2px solid #ff4d4d; margin-right: 10px; }
    .player-name { font-weight: 900; color: #fff; letter-spacing: .2px; }
    .my-profile { background: rgba(255, 255, 255, 0.08); padding: 10px; border-radius: 16px; margin-bottom: 14px; display: flex; align-items: center; border: 1px solid rgba(255,255,255,0.12); }
    .warn-box {
      margin-top:10px; padding:10px 12px; border-radius:14px;
      background: rgba(255, 183, 77, 0.12);
      border: 1px solid rgba(255,183,77,0.35);
      color:#ffcc80; font-size:12px; line-height:1.45;
      display:none;
    }
    .hint-box {
      margin-top:10px; padding:10px 12px; border-radius:14px;
      background: rgba(129, 212, 250, 0.12);
      border: 1px solid rgba(129, 212, 250, 0.28);
      color:#cfefff; font-size:12px; line-height:1.45;
      display:none;
    }

    /* About (O'yin haqida) content - minimal premium */
    .about-wrap { text-align:left; color:#fff; }
    .about-note {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 16px;
      padding: 12px;
      margin-bottom: 12px;
      line-height: 1.5;
      font-size: 13px;
      opacity: 0.95;
    }
    .about-title {
      margin: 0 0 8px;
      font-weight: 950;
      font-size: 14px;
      letter-spacing: .2px;
    }
    .about-ul {
      margin: 8px 0 0;
      padding-left: 18px;
      line-height: 1.55;
      font-size: 13px;
      opacity: 0.95;
    }
    .about-ul li { margin: 7px 0; }
    .about-pill {
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,0.22);
      border: 1px solid rgba(255,255,255,0.14);
      font-size: 12px;
      font-weight: 900;
      opacity: .95;
      margin: 6px 6px 0 0;
      white-space: nowrap;
    }
  </style>
</head>

<body>

  <!-- FON ELEMENTLARI -->
  <div class="bg-elements">
    <img src="assaets/products/tomatoFon.png" class="floating-item" style="top:10%; left:10%;">
    <img src="assaets/products/tomatoFon.png" class="floating-item" style="top:40%; right:15%;">
    <img src="assaets/products/tomatoFon.png" class="floating-item" style="bottom:15%; left:20%;">
  </div>

  <!-- ASOSIY MENYU -->
  <div id="mainMenu" class="menu-container">
    <div class="menu-box">
      <img src="assaets/logo.png" class="game-logo" alt="Tomama Logo">

      <!-- PROFIL -->
      <div id="userProfile" class="my-profile">
        <img id="myAvatar" src="assaets/avatars/1.png" class="avatar-img" alt="Avatar">
        <div style="text-align:left; min-width:0;">
          <span id="myNickname" class="player-name">Yuklanmoqda...</span><br>
          <small style="color:#00f2ff; font-weight:700;">Sizning profilingiz</small>
        </div>
      </div>

      <!-- Guest warning -->
      <div id="guestWarn" class="warn-box">
        Siz hozir <b>Guest</b> sifatida o‚Äòynayapsiz. Reyting va kuponlar to‚Äòliq ishlashi uchun o‚Äòyinni <b>Telegram WebApp</b> orqali oching.
      </div>

      <!-- Profile loading hint -->
      <div id="profileHint" class="hint-box">
        Profil yuklanyapti. 1‚Äì2 soniya kuting‚Ä¶
      </div>

      <div id="recordBox">
        <span class="muted-label">ENG YAXSHI NATIJA</span><br>
        <strong id="personalBest" class="big-score">0</strong><br>
        <span class="diamonds-pill">üíé <span id="totalDiamonds">0</span></span>
      </div>

      <button class="btn-primary" onclick="startGame()">‚ñ∂Ô∏è O'yinni boshlash</button>
      <button onclick="showRanking()">üèÜ Reyting (Top-10)</button>
      <button onclick="showCoupons()">üé´ Kuponlarim</button>
      <button onclick="showAbout()">‚ÑπÔ∏è O‚Äòyin haqida</button>
    </div>
  </div>

  <!-- REYTING MENYUSI -->
  <div id="rankingMenu" class="menu-container hidden">
    <div class="menu-box">
      <h2 class="menu-title">üèÜ Top-10 Reyting</h2>
      <div id="rankingList" class="scroll-box">
        Yuklanmoqda...
      </div>
      <button class="back-btn" onclick="hideAllMenus()">‚¨ÖÔ∏è Ortga</button>
    </div>
  </div>

  <!-- KUPONLAR MENYUSI -->
  <div id="couponsMenu" class="menu-container hidden">
    <div class="menu-box">
      <h2 class="menu-title">üé´ Kuponlar</h2>
      <div id="couponList" class="scroll-box">
        <p style="opacity:0.7;">Yuklanmoqda...</p>
      </div>
      <button class="back-btn" onclick="hideAllMenus()">‚¨ÖÔ∏è Ortga</button>
    </div>
  </div>

  <!-- O‚ÄòYIN HAQIDA MENYUSI -->
  <div id="aboutMenu" class="menu-container hidden">
    <div class="menu-box">
      <h2 class="menu-title">‚ÑπÔ∏è O‚Äòyin haqida</h2>

      <div class="scroll-box">
        <div class="about-wrap">
          <div class="about-note">
            <div class="about-title">Maqsad</div>
            Savatni chap-o‚Äòngga harakatlantirib tushayotgan predmetlarni ushlang.
            Ko‚Äòproq ball va diamond to‚Äòplang, rekordni yangilang.
          </div>

          <div style="margin-bottom:10px;">
            <span class="about-pill">‚ù§Ô∏è Jon: 3 ta</span>
            <span class="about-pill">üî• Combo: ketma-ket ushlash</span>
            <span class="about-pill">üíé Diamond: kuponlar uchun</span>
          </div>

          <div class="about-note">
            <div class="about-title">Predmetlar</div>
            <ul class="about-ul">
              <li><b>üçÖ Oddiy pomidor</b> ‚Äî <b>+10 ball</b> (combo bo‚Äòlsa ball oshadi).</li>
              <li><b>üíé Almaz (brand)</b> ‚Äî <b>+100 ball</b> va <b>+1 diamond</b>.</li>
              <li><b>‚ùÑÔ∏è Muz (snow)</b> ‚Äî o‚Äòyinni vaqtincha sekinlashtiradi.</li>
              <li><b>üß≤ Magnit</b> ‚Äî pomidor/almzlarni savatga tortadi.</li>
              <li><b>üõ°Ô∏è Qalqon</b> ‚Äî 1 marta bombadan himoya qiladi.</li>
              <li><b>üí£ Bomba</b> ‚Äî qalqon bo‚Äòlmasa <b>1 jon kamaytiradi</b>.</li>
            </ul>
          </div>

          <div class="about-note">
            <div class="about-title">Jon yo‚Äòqotish qoidalari</div>
            <ul class="about-ul">
              <li><b>Pomidor</b> yoki <b>Almaz</b> yerga tushib ketsa ‚Äî <b>1 jon ketadi</b>.</li>
              <li><b>Bomba</b>ni ushlab olsangiz ‚Äî qalqon bo‚Äòlmasa <b>1 jon ketadi</b>.</li>
            </ul>
          </div>

          <div class="about-note" style="margin-bottom:0;">
            <div class="about-title">Combo (üî•)</div>
            Ketma-ket ushlash combo‚Äôni oshiradi. Xato (jon ketishi) bo‚Äòlsa combo 0 bo‚Äòladi.
          </div>
        </div>
      </div>

      <button class="back-btn" onclick="hideAllMenus()">‚¨ÖÔ∏è Ortga</button>
    </div>
  </div>

  <!-- O'YIN MAYDONI -->
  <canvas id="gameCanvas" class="hidden"></canvas>

  <script>
    const tg = window.Telegram?.WebApp;

    // Backend URL (o‚Äòzingizniki)
    window.SERVER_URL = SERVER_URL; // game.js uchun

    if (tg) {
      tg.ready();
      tg.expand();
      tg.setHeaderColor("#81d4fa");
      tg.BackButton.onClick(() => hideAllMenus());
    }

    // =========================
    // Helpers
    // =========================
    function showGuestWarning() {
      const el = document.getElementById("guestWarn");
      if (el) el.style.display = "block";
    }
    function hideGuestWarning() {
      const el = document.getElementById("guestWarn");
      if (el) el.style.display = "none";
    }
    function showProfileHint() {
      const el = document.getElementById("profileHint");
      if (el) el.style.display = "block";
    }
    function hideProfileHint() {
      const el = document.getElementById("profileHint");
      if (el) el.style.display = "none";
    }

    function getOrCreateGuestId() {
      let gid = localStorage.getItem("tomama_guest_id");
      if (!gid) {
        gid = (crypto?.randomUUID ? crypto.randomUUID() : String(Math.random()).slice(2) + "_" + Date.now());
        localStorage.setItem("tomama_guest_id", gid);
      }
      return gid;
    }

    function extractAvatarId(avatarPath) {
      const m = String(avatarPath || "").match(/avatars\/(\d+)\.png/i);
      return m ? parseInt(m[1], 10) : 1;
    }

    // Guest uchun random profil (faqat guest yoki tg username bo‚Äòlmasa fallback)
    function getOrGenerateUser() {
      let localUser = localStorage.getItem("tomama_user_2026");
      if (!localUser) {
        const adjectives = ["Chaqqon", "Tezkor", "Olovli", "Super", "Mantiqiy", "Yulduzli", "Oltin", "Botir"];
        const nouns = ["Pomidor", "Tomama", "Chempion", "Usta", "Sardor", "Lochin", "Pahlavon"];
        const randomName = adjectives[Math.floor(Math.random() * adjectives.length)] + " " + nouns[Math.floor(Math.random() * nouns.length)];
        const randomAvatar = `assaets/avatars/${Math.floor(Math.random() * 20) + 1}.png`;
        const newUser = { nickname: randomName, avatar: randomAvatar };
        localStorage.setItem("tomama_user_2026", JSON.stringify(newUser));
        return newUser;
      }
      try { return JSON.parse(localUser); } catch { return { nickname:"Pomidor", avatar:"assaets/avatars/1.png" }; }
    }

    // =========================
    // AUTO REGISTER (profil yaratish / tiklash)
    // =========================
    async function autoRegister() {
      showProfileHint();

      const tgUser = window.Telegram?.WebApp?.initDataUnsafe?.user;
      const localUser = getOrGenerateUser();
      const avatar_id = extractAvatarId(localUser.avatar);

      let payload;

      if (tgUser?.id) {
        hideGuestWarning();
        payload = {
          mode: "telegram",
          telegram_id: tgUser.id,
          username: tgUser.username ? `@${tgUser.username}` : (tgUser.first_name || localUser.nickname),
          avatar_id
        };
      } else {
        showGuestWarning();
        payload = {
          mode: "guest",
          guest_id: getOrCreateGuestId(),
          username: localUser.nickname,
          avatar_id
        };
      }

      try {
        const res = await fetch(`${SERVER_URL}/register`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const data = await res.json();

        if (data?.ok) {
          localStorage.setItem("tomama_identity", data.user.identity);
          localStorage.setItem("tomama_is_guest", String(data.user.is_guest));

          // Diamonds serverdan sync
          if (typeof data.user.diamonds === "number") {
            localStorage.setItem("totalDiamonds", String(data.user.diamonds));
          }

          // Profil UI sync
          localStorage.setItem("tomama_username", data.user.username || payload.username);
          localStorage.setItem("tomama_avatar_id", String(data.user.avatar_id || avatar_id));
        } else {
          console.error("Register failed:", data);
        }
      } catch (e) {
        console.error("Register network error:", e);
      } finally {
        hideProfileHint();
      }
    }

    // =========================
    // UI Sync
    // =========================
    function updateUIStats() {
      const nickname = localStorage.getItem("tomama_username") || getOrGenerateUser().nickname;
      const avatarId = Number(localStorage.getItem("tomama_avatar_id") || 1);

      document.getElementById("myNickname").innerText = nickname;
      document.getElementById("myAvatar").src = `assaets/avatars/${avatarId}.png`;

      document.getElementById("personalBest").innerText = localStorage.getItem("highScore") || 0;
      document.getElementById("totalDiamonds").innerText = localStorage.getItem("totalDiamonds") || 0;
    }
    window.updateUIStats = updateUIStats;

    window.addEventListener("load", async () => {
      await autoRegister();
      updateUIStats();
    });

    // =========================
    // Leaderboard
    // =========================
    async function loadLeaderboard() {
      const list = document.getElementById("rankingList");
      list.innerHTML = "<p style='text-align:center; opacity:0.8;'>Yuklanmoqda...</p>";

      try {
        const res = await fetch(`${SERVER_URL}/leaderboard`);
        if (!res.ok) throw new Error("Server xatosi");
        const data = await res.json();

        list.innerHTML = "";
        if (!data.length) {
          list.innerHTML = "<p style='text-align:center; opacity:0.8;'>Hozircha rekordlar yo'q</p>";
          return;
        }

        data.forEach((player, index) => {
          const medal = index === 0 ? "ü•á" : index === 1 ? "ü•à" : index === 2 ? "ü•â" : `${index + 1}.`;
          const nickname = player.nickname || "NoName";
          const avatar = player.avatar_url || "assaets/avatars/1.png";

          list.innerHTML += `
            <div class="row-item">
              <div class="row-left">
                <div class="medal">${medal}</div>
                <img class="row-avatar" src="${avatar}" alt="avatar">
                <div class="row-name">${nickname}</div>
              </div>
              <div class="row-score">${player.score} üçÖ</div>
            </div>
          `;
        });
      } catch (e) {
        list.innerHTML = "<p style='color:#ff5252; text-align:center;'>Reytingni yuklab bo'lmadi.</p>";
        console.error(e);
      }
    }

    // =========================
    // Coupons
    // =========================
    // (Siz yuborgan kuponlar kodingiz - o'zgartirmadim)

    async function loadCoupons() {
      const identity = localStorage.getItem("tomama_identity");
      const wrap = document.getElementById("couponList");
      if (!wrap) return;

      wrap.innerHTML = `
        <div class="cpn-wrap">
          <div class="cpn-topbar">
            <h3 class="cpn-title">Do‚Äòkon</h3>
            <div class="cpn-balance"><span>üíé</span><strong>...</strong></div>
          </div>
          <div class="cpn-shimmer"></div>
          <div class="cpn-shimmer"></div>
          <div class="cpn-shimmer"></div>
          <div class="cpn-section">
            <h3>Mening kuponlarim</h3>
            <div class="cpn-shimmer"></div>
          </div>
        </div>
      `;

      try {
        const [catRes, myRes] = await Promise.all([
          fetch(`${SERVER_URL}/coupons`),
          identity ? fetch(`${SERVER_URL}/my/coupons?identity=${encodeURIComponent(identity)}`) : Promise.resolve(null)
        ]);

        const cat = await catRes.json();
        const my = myRes ? await myRes.json() : { ok: true, items: [] };
        if (!cat.ok) throw new Error("catalog_error");

        const diamonds = Number(localStorage.getItem("totalDiamonds") || 0);

        let html = `
          <div class="cpn-wrap">
            <div class="cpn-topbar">
              <h3 class="cpn-title">Do‚Äòkon</h3>
              <div class="cpn-balance">
                <span>üíé</span>
                <strong>${diamonds}</strong>
              </div>
            </div>

            <div class="cpn-note">
              Kuponlar serverda tekshiriladi. Sertifikat ko‚Äòrinishida: <b>QR + Voucher Code</b>.
            </div>

            <div class="cpn-grid">
        `;

        cat.coupons.forEach((c) => {
          const cost = Number(c.cost_diamonds || 0);
          const disabled = diamonds < cost;

          html += `
            <div class="cpn-card">
              <div class="cpn-row">
                <div style="min-width:0;">
                  <div class="cpn-badge"><span class="dot"></span> Sertifikat</div>
                  <p class="cpn-name">${escapeHtml(c.title || "")}</p>
                </div>
                <div class="cpn-price">${cost} üíé</div>
              </div>

              <div class="cpn-desc">${escapeHtml(c.description || "")}</div>

              <div class="cpn-actions">
                <button
                  class="cpn-btn cpn-btn-primary"
                  ${disabled ? "disabled" : ""}
                  onclick="exchangeCoupon(${c.id})"
                >
                  ${disabled ? "üíé Yetarli emas" : "Almashtirish"}
                </button>
              </div>
            </div>
          `;
        });

        html += `</div>`;

        html += `
          <div class="cpn-section">
            <div class="cpn-topbar" style="margin-bottom:10px;">
              <h3 class="cpn-title" style="font-size:16px;">Mening kuponlarim</h3>
              <div class="cpn-pill">üîí Bir martalik</div>
            </div>
        `;

        if (!identity) {
          html += `<div class="cpn-empty" style="color:#ffcc80; opacity:0.95;">
            Kuponlar ro‚Äòyxati uchun registratsiya kerak (guest ham bo‚Äòladi).
          </div>`;
        } else if (!my.ok || !my.items?.length) {
          html += `<div class="cpn-empty">Hozircha kupon yo‚Äòq.</div>`;
        } else {
          my.items.forEach((it) => {
            const st = String(it.status || "active").toUpperCase();
            const badge = st === "USED" ? "‚úÖ Ishlatilgan" : "üü¢ Aktiv";

            html += `
              <div class="cpn-card" style="padding:14px;">
                <div class="cpn-row">
                  <div style="min-width:0;">
                    <div class="cpn-badge"><span class="dot"></span> ${badge}</div>
                    <p class="cpn-name">${escapeHtml(it.title || "")}</p>
                  </div>
                  <div class="cpn-pill">${st}</div>
                </div>

                <div class="cpn-desc">
                  Voucher Code: <b style="color:var(--accent-gold);">${escapeHtml(it.voucher_code || "")}</b>
                </div>

                <div class="cpn-actions">
                  <button class="cpn-btn cpn-btn-ghost" onclick="openCertificateByCode('${encodeURIComponent(it.voucher_code || "")}')">
                    Sertifikatni ko‚Äòrish
                  </button>
                </div>
              </div>
            `;
          });
        }

        html += `</div></div>`;
        wrap.innerHTML = html;
      } catch (e) {
        console.error(e);
        wrap.innerHTML = `<p style="color:#ff5252; text-align:center;">Kuponlarni yuklab bo‚Äòlmadi.</p>`;
      }
    }

    async function exchangeCoupon(couponId) {
      const identity = localStorage.getItem("tomama_identity");
      if (!identity) {
        alert("Avval registratsiya kerak.");
        return;
      }

      try {
        const res = await fetch(`${SERVER_URL}/coupons/exchange`, {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ identity, coupon_id: couponId })
        });
        const data = await res.json();

        if (!data.ok) {
          if (data.error === "NOT_ENOUGH_DIAMONDS") {
            alert(`üíé Yetarli emas. Kerak: ${data.need}, Sizda: ${data.have}`);
            return;
          }
          alert("Kupon olishda xatolik.");
          return;
        }

        if (typeof data.certificate?.diamonds_left === "number") {
          localStorage.setItem("totalDiamonds", String(data.certificate.diamonds_left));
          updateUIStats();
        }

        showCertificate({
          title: data.certificate.title,
          code: data.certificate.voucher_code,
          qrDataUrl: data.certificate.qr_data_url,
        });

        loadCoupons();
      } catch (e) {
        console.error(e);
        alert("Server bilan aloqa yo‚Äòq.");
      }
    }

    function openCertificateByCode(voucherCodeEnc) {
      const code = decodeURIComponent(voucherCodeEnc || "");
      showCertificate({
        title: "Kupon Sertifikati",
        code,
        qrDataUrl: null
      });
    }

    function showCertificate({ title, code, qrDataUrl }) {
      let modal = document.getElementById("certModal");
      if (!modal) {
        modal = document.createElement("div");
        modal.id = "certModal";
        modal.className = "cpn-modal";
        modal.innerHTML = `
          <div class="cpn-modal-card">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
              <div>
                <div id="certTitle" style="font-weight:950;font-size:16px;"></div>
                <div style="opacity:0.8;font-size:12px;margin-top:4px;">Sertifikat (QR + Voucher Code)</div>
              </div>
              <button onclick="document.getElementById('certModal').remove()"
                style="background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);
                color:#fff;border-radius:12px;padding:8px 10px;cursor:pointer;font-weight:900;">Yopish</button>
            </div>

            <div style="margin-top:14px;display:flex;gap:14px;align-items:center;">
              <div class="cpn-qr-box">
                <img id="certQR" src="" alt="QR">
              </div>
              <div style="flex:1;">
                <div style="opacity:0.8;font-size:12px;">Voucher Code</div>
                <div id="certCode" style="font-weight:950;font-size:18px;color:var(--accent-gold);margin-top:4px;"></div>

                <button onclick="navigator.clipboard?.writeText(document.getElementById('certCode').innerText)"
                  class="cpn-btn cpn-btn-ghost"
                  style="margin-top:10px;width:100%;">
                  Koddan nusxa olish
                </button>

                <button id="btnDownloadCert"
                  class="cpn-btn cpn-btn-primary"
                  style="margin-top:10px;width:100%;">
                  Sertifikatni yuklab olish (PDF/PNG)
                </button>

                <div style="margin-top:10px;opacity:0.75;font-size:12px;line-height:1.4;">
                  Eslatma: Yuklab olingandan so‚Äòng kupon holati <b>USED</b> bo‚Äòladi.
                </div>
              </div>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      } else {
        document.body.appendChild(modal);
      }

      document.getElementById("certTitle").innerText = title || "Kupon Sertifikati";
      document.getElementById("certCode").innerText = code || "";

      const img = document.getElementById("certQR");

      if (qrDataUrl) {
        img.src = qrDataUrl;
      } else {
        img.src =
          "data:image/svg+xml;charset=utf-8," +
          encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="140" height="140">
            <rect width="140" height="140" rx="18" ry="18" fill="#ffffff"/>
            <text x="70" y="72" text-anchor="middle" font-family="Arial" font-size="14" fill="#111">QR yuklanadi</text>
            <text x="70" y="92" text-anchor="middle" font-family="Arial" font-size="11" fill="#444">Download bosing</text>
          </svg>`);
      }

      const btn = document.getElementById("btnDownloadCert");
      btn.onclick = async () => {
        btn.disabled = true;
        btn.innerText = "Yuklanmoqda...";

        try {
          const identity = localStorage.getItem("tomama_identity");
          if (!identity) {
            alert("Registratsiya topilmadi.");
            return;
          }

          const voucher_code = document.getElementById("certCode").innerText;

          const res = await fetch(`${SERVER_URL}/coupons/download`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ identity, voucher_code })
          });

          const data = await res.json();
          if (!data.ok) {
            alert("Download xatolik.");
            return;
          }

          const cert = data.certificate;
          document.getElementById("certTitle").innerText = cert.title || title || "Kupon Sertifikati";
          document.getElementById("certCode").innerText = cert.voucher_code || voucher_code;
          document.getElementById("certQR").src = cert.qr_data_url;

          await downloadCertificatePNG({
            title: cert.title || title || "Kupon Sertifikati",
            code: cert.voucher_code || voucher_code,
            qrDataUrl: cert.qr_data_url
          });

          await loadCoupons();
        } catch (e) {
          console.error(e);
          alert("Server bilan aloqa yo‚Äòq.");
        } finally {
          btn.disabled = false;
          btn.innerText = "Sertifikatni yuklab olish (PDF/PNG)";
        }
      };
    }

    function escapeHtml(str) {
      return String(str || "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    async function downloadCertificatePNG({ title, code, qrDataUrl, token }) {
      const qrImg = await loadImage(qrDataUrl);

      const w = 1080, h = 650;
      const canvas = document.createElement("canvas");
      canvas.width = w;
      canvas.height = h;
      const c = canvas.getContext("2d");

      c.fillStyle = "#0b0b0f";
      c.fillRect(0, 0, w, h);

      const g = c.createLinearGradient(0, 0, w, h);
      g.addColorStop(0, "rgba(255,82,82,0.35)");
      g.addColorStop(0.5, "rgba(0,242,255,0.18)");
      g.addColorStop(1, "rgba(255,215,0,0.22)");
      c.fillStyle = g;
      c.fillRect(0, 0, w, h);

      roundRect(c, 60, 70, 960, 510, 26);
      c.fillStyle = "rgba(255,255,255,0.10)";
      c.fill();
      c.strokeStyle = "rgba(255,255,255,0.18)";
      c.lineWidth = 2;
      c.stroke();

      c.fillStyle = "#ffffff";
      c.font = "900 42px Arial";
      c.fillText(title, 110, 155);

      c.fillStyle = "rgba(255,255,255,0.75)";
      c.font = "600 22px Arial";
      c.fillText("Sertifikat (QR + Voucher Code)", 110, 195);

      roundRect(c, 110, 245, 260, 260, 24);
      c.fillStyle = "#ffffff";
      c.fill();
      c.drawImage(qrImg, 125, 260, 230, 230);

      c.fillStyle = "rgba(255,255,255,0.75)";
      c.font = "700 22px Arial";
      c.fillText("Voucher Code", 420, 285);

      c.fillStyle = "#ffd700";
      c.font = "900 44px Arial";
      c.fillText(code, 420, 340);

      c.fillStyle = "rgba(255,255,255,0.70)";
      c.font = "600 18px Arial";
      c.fillText("Yuklab olingan kupon USED holatiga o‚Äòtadi.", 420, 385);

      c.fillStyle = "rgba(255,255,255,0.55)";
      c.font = "600 16px Arial";
      c.fillText("Tomama 2026", 110, 540);

      const dataUrl = canvas.toDataURL("image/png");

      if (window.Telegram?.WebApp) {
        const win = window.open();
        if (win) {
          win.document.write(`
            <html>
              <head>
                <title>Tomama Certificate</title>
                <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
              </head>
              <body style="margin:0;background:#000;display:flex;align-items:center;justify-content:center;">
                <img src="${dataUrl}" style="width:100%;height:auto;" />
              </body>
            </html>
          `);
          win.document.close();
        } else {
          window.location.href = dataUrl;
        }

        if (token) {
          try {
            await fetch(`${SERVER_URL}/coupons/mark-used`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ token })
            });
          } catch (e) {
            console.warn("mark-used failed:", e);
          }
        }
        return;
      }

      const a = document.createElement("a");
      a.href = dataUrl;
      a.download = `tomama-certificate-${code}.png`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);

      if (token) {
        try {
          await fetch(`${SERVER_URL}/coupons/mark-used`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ token })
          });
        } catch (e) {
          console.warn("mark-used failed:", e);
        }
      }
    }

    function roundRect(ctx, x, y, w, h, r) {
      const rr = Math.min(r, w / 2, h / 2);
      ctx.beginPath();
      ctx.moveTo(x + rr, y);
      ctx.arcTo(x + w, y, x + w, y + h, rr);
      ctx.arcTo(x + w, y + h, x, y + h, rr);
      ctx.arcTo(x, y + h, x, y, rr);
      ctx.arcTo(x, y, x + w, y, rr);
      ctx.closePath();
    }

    function loadImage(src) {
      return new Promise((resolve, reject) => {
        const im = new Image();
        im.onload = () => resolve(im);
        im.onerror = reject;
        im.src = src;
      });
    }

    // =========================
    // Menu Functions
    // =========================
    async function startGame() {
      document.getElementById("mainMenu").classList.add("hidden");
      document.getElementById("gameCanvas").classList.remove("hidden");
      if (window.startGameLoop) await window.startGameLoop();
    }

    function showRanking() {
      tg?.BackButton.show();
      document.getElementById("mainMenu").classList.add("hidden");
      document.getElementById("rankingMenu").classList.remove("hidden");
      loadLeaderboard();
    }

    function showCoupons() {
      tg?.BackButton.show();
      document.getElementById("mainMenu").classList.add("hidden");
      document.getElementById("couponsMenu").classList.remove("hidden");
      loadCoupons();
    }

    function showAbout() {
      tg?.BackButton.show();
      document.getElementById("mainMenu").classList.add("hidden");
      document.getElementById("aboutMenu").classList.remove("hidden");
    }

    function hideAllMenus() {
      tg?.BackButton.hide();
      document.querySelectorAll(".menu-container").forEach(m => m.classList.add("hidden"));
      document.getElementById("mainMenu").classList.remove("hidden");
      updateUIStats();
    }
  </script>

  <script src="game.js"></script>
</body>
</html>
