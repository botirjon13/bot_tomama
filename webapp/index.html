<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Tomama 2026 - Random Edition</title>

  <!-- Telegram SDK (HEAD ichida bo‚Äòlsin) -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <link rel="stylesheet" href="style.css">

  <style>
    .avatar-img { width: 36px; height: 36px; border-radius: 50%; border: 2px solid #ff4d4d; margin-right: 10px; }
    .player-name { font-weight: bold; color: #fff; }
    .my-profile { background: rgba(255, 255, 255, 0.1); padding: 10px; border-radius: 10px; margin-bottom: 15px; display: flex; align-items: center; }
    .warn-box { margin-top:10px; padding:10px; border-radius:12px; background: rgba(255, 183, 77, 0.12); border: 1px solid rgba(255,183,77,0.35); color:#ffcc80; font-size:12px; line-height:1.4; display:none; }

    /* Name modal */
    .modal-wrap{
      position:fixed; inset:0; z-index:10000;
      background:rgba(0,0,0,0.75);
      display:flex; align-items:center; justify-content:center;
      padding:18px;
    }
    .modal-card{
      width:100%; max-width:420px;
      background:rgba(255,255,255,0.10);
      border:1px solid rgba(255,255,255,0.18);
      border-radius:18px;
      padding:16px;
      color:#fff;
      backdrop-filter: blur(12px);
    }
    .modal-title{ font-weight:900; font-size:16px; margin:0; }
    .modal-sub{ opacity:0.8; font-size:12px; margin-top:6px; line-height:1.4; }
    .modal-input{
      width:100%; margin-top:12px;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(255,255,255,0.08);
      color:#fff; font-weight:800;
      outline:none;
    }
    .modal-row{ display:flex; gap:10px; margin-top:12px; }
    .btn{
      width:100%;
      padding:12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.12);
      background:rgba(255,255,255,0.08);
      color:#fff;
      font-weight:900;
      cursor:pointer;
    }
    .btn-primary{
      border:none;
      background: linear-gradient(135deg, #ff5252 0%, #b71c1c 100%);
    }
    .btn:disabled{
      cursor:not-allowed;
      opacity:0.6;
    }
  </style>
</head>
<body>

  <!-- FON ELEMENTLARI -->
  <div class="bg-elements">
    <img src="assaets/products/tomatoFon.png" class="floating-item" style="top:10%; left:10%;">
    <img src="assaets/products/tomatoFon.png" class="floating-item" style="top:40%; right:15%;">
    <img src="assaets/products/tomatoFon.png" class="floating-item" style="bottom:15%; left:20%;">
  </div>

  <!-- ASOSIY MENYU -->
  <div id="mainMenu" class="menu-container">
    <div class="menu-box">
      <img src="assaets/logo.png" class="game-logo" alt="Tomama Logo">

      <!-- PROFIL -->
      <div id="userProfile" class="my-profile">
        <img id="myAvatar" src="assaets/avatars/1.png" class="avatar-img" alt="Avatar">
        <div style="text-align:left;">
          <span id="myNickname" class="player-name">Yuklanmoqda...</span><br>
          <small style="color:#00f2ff;">Sizning profilingiz</small>
        </div>
      </div>

      <!-- Guest warning -->
      <div id="guestWarn" class="warn-box">
        Siz hozir <b>Guest</b> sifatida o‚Äòynayapsiz. Reyting va kuponlar to‚Äòliq ishlashi uchun o‚Äòyinni <b>Telegram WebApp</b> orqali oching.
      </div>

      <div id="recordBox">
        <span style="opacity: 0.7; font-size: 0.8em;">ENG YAXSHI NATIJA</span><br>
        <strong id="personalBest">0</strong><br>
        <span style="color: #00f2ff; font-weight: bold; font-size: 1.1em;">üíé <span id="totalDiamonds">0</span></span>
      </div>

      <button onclick="startGame()">‚ñ∂Ô∏è O'yinni boshlash</button>
      <button onclick="showRanking()">üèÜ Reyting (Top-10)</button>
      <button onclick="showCoupons()">üé´ Kuponlarim</button>
    </div>
  </div>

  <!-- REYTING MENYUSI -->
  <div id="rankingMenu" class="menu-container hidden">
    <div class="menu-box">
      <h2 style="color: white; margin-top: 0; margin-bottom: 20px;">üèÜ Top-10 Reyting</h2>
      <div id="rankingList" style="color:white; min-height:150px; text-align:left; overflow-y:auto; max-height:250px;">
        Yuklanmoqda...
      </div>
      <button class="back-btn" style="margin-top: 20px;" onclick="hideAllMenus()">‚¨ÖÔ∏è Ortga</button>
    </div>
  </div>

  <!-- KUPONLAR MENYUSI -->
  <div id="couponsMenu" class="menu-container hidden">
    <div class="menu-box">
      <h2 style="color:white; margin-top:0;">üé´ Kuponlarim</h2>
      <div id="couponList" style="color:white; margin-bottom: 20px;">
        <p style="opacity:0.7;">Yuklanmoqda...</p>
      </div>
      <button class="back-btn" onclick="hideAllMenus()">‚¨ÖÔ∏è Ortga</button>
    </div>
  </div>

  <!-- O'YIN MAYDONI -->
  <canvas id="gameCanvas" class="hidden"></canvas>

  <script>
    const tg = window.Telegram?.WebApp;

    // Backend URL
    const SERVER_URL = "https://oyinbackent-production.up.railway.app";

    // global flags
    window.TOMAMA_READY = false;

    if (tg) {
      tg.ready();
      tg.expand();
      tg.setHeaderColor("#81d4fa");
      tg.BackButton.onClick(() => hideAllMenus());
    }

    function showGuestWarning() {
      const el = document.getElementById("guestWarn");
      if (el) el.style.display = "block";
    }
    function hideGuestWarning() {
      const el = document.getElementById("guestWarn");
      if (el) el.style.display = "none";
    }

    // ------------------------------
    // Guest ID (browser uchun)
    // ------------------------------
    function getOrCreateGuestId() {
      let gid = localStorage.getItem("tomama_guest_id");
      if (!gid) {
        gid = crypto?.randomUUID ? crypto.randomUUID() : String(Math.random()).slice(2) + "_" + Date.now();
        localStorage.setItem("tomama_guest_id", gid);
      }
      return gid;
    }

    // ------------------------------
    // Avatar ID
    // ------------------------------
    function extractAvatarId(avatarPath) {
      const m = String(avatarPath || "").match(/avatars\/(\d+)\.png/i);
      return m ? parseInt(m[1], 10) : 1;
    }

    // ------------------------------
    // Local random avatar (faqat avatar uchun)
    // ------------------------------
    function getOrPickAvatar() {
      const stored = localStorage.getItem("tomama_avatar_id");
      if (stored) return Math.max(1, Math.min(50, parseInt(stored, 10) || 1));

      const randomId = Math.floor(Math.random() * 20) + 1;
      localStorage.setItem("tomama_avatar_id", String(randomId));
      return randomId;
    }

    // ------------------------------
    // Name storage (endilikda random emas)
    // ------------------------------
    function getSavedName() {
      return String(localStorage.getItem("tomama_username") || "").trim();
    }
    function setSavedName(name) {
      const clean = String(name || "").trim().slice(0, 48);
      if (clean) localStorage.setItem("tomama_username", clean);
      return clean;
    }

    function suggestNameFromTelegramOrFallback() {
      const tgUser = window.Telegram?.WebApp?.initDataUnsafe?.user;
      if (tgUser?.username) return `@${tgUser.username}`;
      if (tgUser?.first_name) return tgUser.first_name;
      return "";
    }

    // ------------------------------
    // Name modal (1-marta kirganda)
    // ------------------------------
    async function ensureNameModal() {
      let name = getSavedName();
      if (name) return name;

      const suggested = suggestNameFromTelegramOrFallback();
      const avatarId = getOrPickAvatar();

      return await new Promise((resolve) => {
        const wrap = document.createElement("div");
        wrap.className = "modal-wrap";
        wrap.id = "nameModal";
        wrap.innerHTML = `
          <div class="modal-card">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
              <div>
                <p class="modal-title">Ismingizni kiriting</p>
                <div class="modal-sub">
                  Bu ism reyting va kuponlarda ko‚Äòrinadi. Keyin ham o‚Äòzgartira olasiz.
                </div>
              </div>
              <img src="assaets/avatars/${avatarId}.png" style="width:44px;height:44px;border-radius:50%;border:2px solid #ff4d4d;">
            </div>

            <input id="nameInput" class="modal-input" placeholder="Masalan: Ilhomjon" value="${suggested ? suggested.replace(/"/g,'&quot;') : ""}">

            <div class="modal-row">
              <button id="btnGuest" class="btn">Guest bo‚Äòlib davom etish</button>
              <button id="btnSave" class="btn btn-primary" disabled>Saqlash</button>
            </div>

            <div class="modal-sub" style="margin-top:10px;">
              Agar Telegram WebApp orqali kirsangiz, reyting va kuponlar 100% ishlaydi.
            </div>
          </div>
        `;
        document.body.appendChild(wrap);

        const input = wrap.querySelector("#nameInput");
        const btnSave = wrap.querySelector("#btnSave");
        const btnGuest = wrap.querySelector("#btnGuest");

        const validate = () => {
          const v = String(input.value || "").trim();
          btnSave.disabled = v.length < 2;
        };
        validate();
        input.addEventListener("input", validate);

        btnSave.addEventListener("click", () => {
          const v = setSavedName(input.value);
          document.getElementById("nameModal")?.remove();
          resolve(v);
        });

        btnGuest.addEventListener("click", () => {
          // guest ham ism bilan kiradi (talabingiz bo‚Äòyicha)
          const v = setSavedName(input.value || "O‚Äòyinchi");
          document.getElementById("nameModal")?.remove();
          resolve(v);
        });
      });
    }

    // ------------------------------
    // AUTO REGISTER (DB bilan)
    // ------------------------------
    async function autoRegister() {
      const tgUser = window.Telegram?.WebApp?.initDataUnsafe?.user;

      // ism majburiy
      const chosenName = await ensureNameModal();

      const avatar_id = getOrPickAvatar();

      let payload;
      let mode = "guest";

      // Telegram orqali kirgan bo‚Äòlsa
      if (tgUser?.id) {
        hideGuestWarning();
        mode = "telegram";
        payload = {
          mode,
          telegram_id: tgUser.id,
          username: chosenName,
          avatar_id
        };
      } else {
        // Browser guest
        showGuestWarning();
        mode = "guest";
        payload = {
          mode,
          guest_id: getOrCreateGuestId(),
          username: chosenName,
          avatar_id
        };
      }

      const res = await fetch(`${SERVER_URL}/register`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const data = await res.json();

      if (data?.ok) {
        localStorage.setItem("tomama_identity", data.user.identity);
        localStorage.setItem("tomama_is_guest", String(data.user.is_guest));

        // diamonds sync
        if (typeof data.user.diamonds === "number") {
          localStorage.setItem("totalDiamonds", String(data.user.diamonds));
        }

        // username/avatar sync (DBdan kelganini olamiz)
        if (data.user.username) localStorage.setItem("tomama_username", data.user.username);
        if (typeof data.user.avatar_id === "number") localStorage.setItem("tomama_avatar_id", String(data.user.avatar_id));

        window.TOMAMA_READY = true;
      } else {
        console.error("Register failed:", data);
        window.TOMAMA_READY = false;
      }
    }

    // ------------------------------
    // UI stats yangilash
    // ------------------------------
    function updateUIStats() {
      const nickname = localStorage.getItem("tomama_username") || "O‚Äòyinchi";
      const avatarId = Number(localStorage.getItem("tomama_avatar_id") || 1);
      const avatarPath = `assaets/avatars/${avatarId}.png`;

      document.getElementById("myNickname").innerText = nickname;
      document.getElementById("myAvatar").src = avatarPath;

      document.getElementById("personalBest").innerText = localStorage.getItem("highScore") || 0;
      document.getElementById("totalDiamonds").innerText = localStorage.getItem("totalDiamonds") || 0;
    }

    window.addEventListener("load", async () => {
      await autoRegister();
      updateUIStats();
    });

    // ------------------------------
    // LEADERBOARD
    // ------------------------------
    async function loadLeaderboard() {
      const list = document.getElementById("rankingList");
      list.innerHTML = "<p style='text-align:center;'>Yuklanmoqda...</p>";

      try {
        const res = await fetch(`${SERVER_URL}/leaderboard`);
        if (!res.ok) throw new Error("Server xatosi");
        const data = await res.json();

        list.innerHTML = "";
        if (!data.length) {
          list.innerHTML = "<p style='text-align:center;'>Hozircha rekordlar yo'q</p>";
          return;
        }

        data.forEach((player, index) => {
          const medal = index === 0 ? "ü•á" : index === 1 ? "ü•à" : index === 2 ? "ü•â" : `${index + 1}.`;
          const nickname = player.nickname || "NoName";
          const avatar = player.avatar_url || "assaets/avatars/1.png";

          const playerRow = `
            <div style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid rgba(255,255,255,0.1);">
              <div style="display:flex; align-items:center;">
                <span style="margin-right:8px; width:20px;">${medal}</span>
                <img src="${avatar}" style="width:32px; height:32px; border-radius:50%; margin-right:10px; border:1px solid #ff4d4d;">
                <span>${nickname}</span>
              </div>
              <strong style="color:#ffd700;">${player.score} üçÖ</strong>
            </div>
          `;
          list.innerHTML += playerRow;
        });
      } catch (e) {
        list.innerHTML = "<p style='color:#ff5252; text-align:center;'>Reytingni yuklab bo'lmadi.</p>";
        console.error(e);
      }
    }

    // ------------------------------
    // COUPONS
    // ------------------------------
    async function loadCoupons() {
      const identity = localStorage.getItem("tomama_identity");
      const wrap = document.getElementById("couponList");
      if (!wrap) return;

      wrap.innerHTML = "<p style='opacity:0.7'>Yuklanmoqda...</p>";

      try {
        const [catRes, myRes] = await Promise.all([
          fetch(`${SERVER_URL}/coupons`),
          identity ? fetch(`${SERVER_URL}/my/coupons?identity=${encodeURIComponent(identity)}`) : Promise.resolve(null)
        ]);

        const cat = await catRes.json();
        const my = myRes ? await myRes.json() : { ok: true, items: [] };

        if (!cat.ok) throw new Error("catalog_error");

        const diamonds = Number(localStorage.getItem("totalDiamonds") || 0);

        let html = "";
        html += `<div style="margin-bottom:16px;">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <h3 style="margin:0;color:#fff;">Do‚Äòkon</h3>
            <div style="color:#00f2ff;font-weight:700;">üíé ${diamonds}</div>
          </div>
          <div style="opacity:0.7;color:#fff;font-size:12px;margin-top:6px;">
            Kuponlar serverda tekshiriladi. QR + Kod sertifikat ko‚Äòrinishida beriladi.
          </div>
        </div>`;

        cat.coupons.forEach(c => {
          const disabled = diamonds < Number(c.cost_diamonds);
          html += `
            <div style="padding:12px;border:1px solid rgba(255,255,255,0.12);border-radius:14px;margin-bottom:10px;">
              <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;">
                <div style="color:#fff;font-weight:800;">${c.title}</div>
                <div style="color:#ffd700;font-weight:800;">${c.cost_diamonds} üíé</div>
              </div>
              <div style="color:#fff;opacity:0.7;font-size:12px;margin-top:6px;">${c.description || ""}</div>
              <button
                style="margin-top:10px;width:100%;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.12);
                  background:${disabled ? "rgba(255,255,255,0.06)" : "linear-gradient(135deg,#ff5252,#b71c1c)"};
                  color:#fff;font-weight:900;cursor:${disabled ? "not-allowed" : "pointer"};"
                ${disabled ? "disabled" : ""}
                onclick="exchangeCoupon(${c.id})"
              >
                ${disabled ? "üíé Yetarli emas" : "Almashtirish"}
              </button>
            </div>
          `;
        });

        html += `<hr style="border:0;border-top:1px solid rgba(255,255,255,0.12);margin:16px 0;">`;
        html += `<h3 style="margin:0 0 10px;color:#fff;">Mening kuponlarim</h3>`;

        if (!identity) {
          html += `<p style="color:#ffb74d;opacity:0.95;font-size:13px;">
            Kuponlar ro‚Äòyxati uchun registratsiya kerak (guest ham bo‚Äòladi).
          </p>`;
        } else if (!my.ok || my.items.length === 0) {
          html += `<p style="opacity:0.7;color:#fff;">Hozircha kupon yo‚Äòq.</p>`;
        } else {
          my.items.forEach(it => {
            const st = (it.status || "active").toUpperCase();
            html += `
              <div style="padding:12px;border:1px solid rgba(255,255,255,0.12);border-radius:14px;margin-bottom:10px;color:#fff;">
                <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
                  <div style="font-weight:800;">${it.title}</div>
                  <div style="opacity:0.9;font-size:12px;">${st}</div>
                </div>
                <div style="margin-top:8px;font-size:13px;">
                  Voucher Code: <b style="color:#ffd700;">${it.voucher_code}</b>
                </div>
                <div style="opacity:0.7;font-size:12px;margin-top:6px;">
                  QR skan bo‚Äòlsa kupon ‚ÄúUsed‚Äù bo‚Äòladi (bir martalik).
                </div>
              </div>
            `;
          });
        }

        wrap.innerHTML = html;
      } catch (e) {
        wrap.innerHTML = `<p style="color:#ff5252;">Kuponlarni yuklab bo‚Äòlmadi.</p>`;
        console.error(e);
      }
    }

    async function exchangeCoupon(couponId) {
      const identity = localStorage.getItem("tomama_identity");
      if (!identity) {
        alert("Avval registratsiya kerak.");
        return;
      }

      try {
        const res = await fetch(`${SERVER_URL}/coupons/exchange`, {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ identity, coupon_id: couponId })
        });

        const data = await res.json();

        if (!data.ok) {
          if (data.error === "NOT_ENOUGH_DIAMONDS") {
            alert(`üíé Yetarli emas. Kerak: ${data.need}, Sizda: ${data.have}`);
            return;
          }
          alert("Kupon olishda xatolik.");
          return;
        }

        // Local diamonds sync
        if (typeof data.certificate?.diamonds_left === "number") {
          localStorage.setItem("totalDiamonds", String(data.certificate.diamonds_left));
          updateUIStats();
        }

        // Show certificate (QR + Code)
        showCertificate(
          data.certificate.voucher_code,
          data.certificate.qr_data_url,
          data.certificate.title
        );

        // reload list
        loadCoupons();
      } catch (e) {
        console.error(e);
        alert("Server bilan aloqa yo‚Äòq.");
      }
    }

    function showCertificate(code, qrDataUrl, title) {
      let modal = document.getElementById("certModal");
      if (!modal) {
        modal = document.createElement("div");
        modal.id = "certModal";
        modal.style.cssText = `
          position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,0.75);
          display:flex;align-items:center;justify-content:center;padding:18px;
        `;
        modal.innerHTML = `
          <div style="width:100%;max-width:420px;background:rgba(255,255,255,0.10);border:1px solid rgba(255,255,255,0.18);
            border-radius:18px;padding:16px;color:#fff;backdrop-filter:blur(12px);">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
              <div>
                <div id="certTitle" style="font-weight:900;font-size:16px;"></div>
                <div style="opacity:0.8;font-size:12px;margin-top:4px;">Sertifikat (QR + Voucher Code)</div>
              </div>
              <button onclick="document.getElementById('certModal').remove()"
                style="background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);
                color:#fff;border-radius:10px;padding:8px 10px;cursor:pointer;">Yopish</button>
            </div>

            <div style="margin-top:14px;display:flex;gap:14px;align-items:center;">
              <div style="width:140px;height:140px;border-radius:14px;background:#fff;display:flex;align-items:center;justify-content:center;">
                <img id="certQR" src="" style="width:130px;height:130px;">
              </div>
              <div style="flex:1;">
                <div style="opacity:0.8;font-size:12px;">Voucher Code</div>
                <div id="certCode" style="font-weight:950;font-size:18px;color:#ffd700;margin-top:4px;"></div>
                <button onclick="navigator.clipboard?.writeText(document.getElementById('certCode').innerText)"
                  style="margin-top:10px;width:100%;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,0.12);
                  background:rgba(255,255,255,0.08);color:#fff;font-weight:900;cursor:pointer;">Koddan nusxa olish</button>
              </div>
            </div>

            <div style="margin-top:12px;opacity:0.75;font-size:12px;">
              QR skan qilinsa kupon ‚ÄúUsed‚Äù bo‚Äòladi (bir martalik).
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      } else {
        document.body.appendChild(modal);
      }

      document.getElementById("certTitle").innerText = title || "Kupon Sertifikati";
      document.getElementById("certCode").innerText = code || "";
      const img = document.getElementById("certQR");
      img.src = qrDataUrl || "data:image/png;base64,iVBORw0KGgo=";
    }

    // ------------------------------
    // MENYU FUNKSIYALARI
    // ------------------------------
    function startGame() {
      if (!window.TOMAMA_READY) {
        alert("Profil yuklanyapti. 1-2 soniya kuting.");
        return;
      }
      tg?.HapticFeedback?.impactOccurred("medium");
      document.getElementById("mainMenu").classList.add("hidden");
      document.getElementById("gameCanvas").classList.remove("hidden");
      if (window.startGameLoop) window.startGameLoop();
    }

    function showRanking() {
      tg?.BackButton.show();
      document.getElementById("mainMenu").classList.add("hidden");
      document.getElementById("rankingMenu").classList.remove("hidden");
      loadLeaderboard();
    }

    function showCoupons() {
      tg?.BackButton.show();
      document.getElementById("mainMenu").classList.add("hidden");
      document.getElementById("couponsMenu").classList.remove("hidden");
      loadCoupons();
    }

    function hideAllMenus() {
      tg?.BackButton.hide();
      document.querySelectorAll(".menu-container").forEach(m => m.classList.add("hidden"));
      document.getElementById("mainMenu").classList.remove("hidden");
      updateUIStats();
    }
  </script>

  <!-- O'yin logikasi -->
  <script src="game.js"></script>
</body>
</html>
