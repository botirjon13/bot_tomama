<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Tomama 2026</title>

  <!-- Telegram SDK (HEAD ichida bo‚Äòlsin) -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <link rel="stylesheet" href="style.css">

  <style>
    .avatar-img { width: 36px; height: 36px; border-radius: 50%; border: 2px solid #ff4d4d; margin-right: 10px; }
    .player-name { font-weight: 900; color: #fff; letter-spacing: .2px; }
    .my-profile { background: rgba(255, 255, 255, 0.08); padding: 10px; border-radius: 16px; margin-bottom: 14px; display: flex; align-items: center; border: 1px solid rgba(255,255,255,0.12); }
    .warn-box {
      margin-top:10px; padding:10px 12px; border-radius:14px;
      background: rgba(255, 183, 77, 0.12);
      border: 1px solid rgba(255,183,77,0.35);
      color:#ffcc80; font-size:12px; line-height:1.45;
      display:none;
    }
    .hint-box {
      margin-top:10px; padding:10px 12px; border-radius:14px;
      background: rgba(129, 212, 250, 0.12);
      border: 1px solid rgba(129, 212, 250, 0.28);
      color:#cfefff; font-size:12px; line-height:1.45;
      display:none;
    }
  </style>
</head>

<body>

  <!-- FON ELEMENTLARI -->
  <div class="bg-elements">
    <img src="assaets/products/tomatoFon.png" class="floating-item" style="top:10%; left:10%;">
    <img src="assaets/products/tomatoFon.png" class="floating-item" style="top:40%; right:15%;">
    <img src="assaets/products/tomatoFon.png" class="floating-item" style="bottom:15%; left:20%;">
  </div>

  <!-- ASOSIY MENYU -->
  <div id="mainMenu" class="menu-container">
    <div class="menu-box">
      <img src="assaets/logo.png" class="game-logo" alt="Tomama Logo">

      <!-- PROFIL -->
      <div id="userProfile" class="my-profile">
        <img id="myAvatar" src="assaets/avatars/1.png" class="avatar-img" alt="Avatar">
        <div style="text-align:left; min-width:0;">
          <span id="myNickname" class="player-name">Yuklanmoqda...</span><br>
          <small style="color:#00f2ff; font-weight:700;">Sizning profilingiz</small>
        </div>
      </div>

      <!-- Guest warning -->
      <div id="guestWarn" class="warn-box">
        Siz hozir <b>Guest</b> sifatida o‚Äòynayapsiz. Reyting va kuponlar to‚Äòliq ishlashi uchun o‚Äòyinni <b>Telegram WebApp</b> orqali oching.
      </div>

      <!-- Profile loading hint -->
      <div id="profileHint" class="hint-box">
        Profil yuklanyapti. 1‚Äì2 soniya kuting‚Ä¶
      </div>

      <div id="recordBox">
        <span class="muted-label">ENG YAXSHI NATIJA</span><br>
        <strong id="personalBest" class="big-score">0</strong><br>
        <span class="diamonds-pill">üíé <span id="totalDiamonds">0</span></span>
      </div>

      <button class="btn-primary" onclick="startGame()">‚ñ∂Ô∏è O'yinni boshlash</button>
      <button onclick="showRanking()">üèÜ Reyting (Top-10)</button>
      <button onclick="showCoupons()">üé´ Kuponlarim</button>
    </div>
  </div>

  <!-- REYTING MENYUSI -->
  <div id="rankingMenu" class="menu-container hidden">
    <div class="menu-box">
      <h2 class="menu-title">üèÜ Top-10 Reyting</h2>
      <div id="rankingList" class="scroll-box">
        Yuklanmoqda...
      </div>
      <button class="back-btn" onclick="hideAllMenus()">‚¨ÖÔ∏è Ortga</button>
    </div>
  </div>

  <!-- KUPONLAR MENYUSI -->
  <div id="couponsMenu" class="menu-container hidden">
    <div class="menu-box">
      <h2 class="menu-title">üé´ Kuponlar</h2>
      <div id="couponList" class="scroll-box">
        <p style="opacity:0.7;">Yuklanmoqda...</p>
      </div>
      <button class="back-btn" onclick="hideAllMenus()">‚¨ÖÔ∏è Ortga</button>
    </div>
  </div>

  <!-- O'YIN MAYDONI -->
  <canvas id="gameCanvas" class="hidden"></canvas>

  <script>
    const tg = window.Telegram?.WebApp;

    // Backend URL (o‚Äòzingizniki)
    const SERVER_URL = "https://oyinbackent-production.up.railway.app";
    window.SERVER_URL = SERVER_URL; // game.js uchun

    if (tg) {
      tg.ready();
      tg.expand();
      tg.setHeaderColor("#81d4fa");
      tg.BackButton.onClick(() => hideAllMenus());
    }

    // =========================
    // Helpers
    // =========================
    function showGuestWarning() {
      const el = document.getElementById("guestWarn");
      if (el) el.style.display = "block";
    }
    function hideGuestWarning() {
      const el = document.getElementById("guestWarn");
      if (el) el.style.display = "none";
    }
    function showProfileHint() {
      const el = document.getElementById("profileHint");
      if (el) el.style.display = "block";
    }
    function hideProfileHint() {
      const el = document.getElementById("profileHint");
      if (el) el.style.display = "none";
    }

    function getOrCreateGuestId() {
      let gid = localStorage.getItem("tomama_guest_id");
      if (!gid) {
        gid = (crypto?.randomUUID ? crypto.randomUUID() : String(Math.random()).slice(2) + "_" + Date.now());
        localStorage.setItem("tomama_guest_id", gid);
      }
      return gid;
    }

    function extractAvatarId(avatarPath) {
      const m = String(avatarPath || "").match(/avatars\/(\d+)\.png/i);
      return m ? parseInt(m[1], 10) : 1;
    }

    // Guest uchun random profil (faqat guest yoki tg username bo‚Äòlmasa fallback)
    function getOrGenerateUser() {
      let localUser = localStorage.getItem("tomama_user_2026");
      if (!localUser) {
        const adjectives = ["Chaqqon", "Tezkor", "Olovli", "Super", "Mantiqiy", "Yulduzli", "Oltin", "Botir"];
        const nouns = ["Pomidor", "Tomama", "Chempion", "Usta", "Sardor", "Lochin", "Pahlavon"];
        const randomName = adjectives[Math.floor(Math.random() * adjectives.length)] + " " + nouns[Math.floor(Math.random() * nouns.length)];
        const randomAvatar = `assaets/avatars/${Math.floor(Math.random() * 20) + 1}.png`;
        const newUser = { nickname: randomName, avatar: randomAvatar };
        localStorage.setItem("tomama_user_2026", JSON.stringify(newUser));
        return newUser;
      }
      try { return JSON.parse(localUser); } catch { return { nickname:"Pomidor", avatar:"assaets/avatars/1.png" }; }
    }

    // =========================
    // AUTO REGISTER (profil yaratish / tiklash)
    // =========================
    async function autoRegister() {
      showProfileHint();

      const tgUser = window.Telegram?.WebApp?.initDataUnsafe?.user;
      const localUser = getOrGenerateUser();
      const avatar_id = extractAvatarId(localUser.avatar);

      let payload;

      if (tgUser?.id) {
        hideGuestWarning();
        payload = {
          mode: "telegram",
          telegram_id: tgUser.id,
          username: tgUser.username ? `@${tgUser.username}` : (tgUser.first_name || localUser.nickname),
          avatar_id
        };
      } else {
        showGuestWarning();
        payload = {
          mode: "guest",
          guest_id: getOrCreateGuestId(),
          username: localUser.nickname,
          avatar_id
        };
      }

      try {
        const res = await fetch(`${SERVER_URL}/register`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const data = await res.json();

        if (data?.ok) {
          localStorage.setItem("tomama_identity", data.user.identity);
          localStorage.setItem("tomama_is_guest", String(data.user.is_guest));

          // Diamonds serverdan sync
          if (typeof data.user.diamonds === "number") {
            localStorage.setItem("totalDiamonds", String(data.user.diamonds));
          }

          // Profil UI sync
          localStorage.setItem("tomama_username", data.user.username || payload.username);
          localStorage.setItem("tomama_avatar_id", String(data.user.avatar_id || avatar_id));
        } else {
          console.error("Register failed:", data);
        }
      } catch (e) {
        console.error("Register network error:", e);
      } finally {
        hideProfileHint();
      }
    }

    // =========================
    // UI Sync
    // =========================
    function updateUIStats() {
      const nickname = localStorage.getItem("tomama_username") || getOrGenerateUser().nickname;
      const avatarId = Number(localStorage.getItem("tomama_avatar_id") || 1);

      document.getElementById("myNickname").innerText = nickname;
      document.getElementById("myAvatar").src = `assaets/avatars/${avatarId}.png`;

      document.getElementById("personalBest").innerText = localStorage.getItem("highScore") || 0;
      document.getElementById("totalDiamonds").innerText = localStorage.getItem("totalDiamonds") || 0;
    }
    window.updateUIStats = updateUIStats;

    window.addEventListener("load", async () => {
      await autoRegister();
      updateUIStats();
    });

    // =========================
    // Leaderboard
    // =========================
    async function loadLeaderboard() {
      const list = document.getElementById("rankingList");
      list.innerHTML = "<p style='text-align:center; opacity:0.8;'>Yuklanmoqda...</p>";

      try {
        const res = await fetch(`${SERVER_URL}/leaderboard`);
        if (!res.ok) throw new Error("Server xatosi");
        const data = await res.json();

        list.innerHTML = "";
        if (!data.length) {
          list.innerHTML = "<p style='text-align:center; opacity:0.8;'>Hozircha rekordlar yo'q</p>";
          return;
        }

        data.forEach((player, index) => {
          const medal = index === 0 ? "ü•á" : index === 1 ? "ü•à" : index === 2 ? "ü•â" : `${index + 1}.`;
          const nickname = player.nickname || "NoName";
          const avatar = player.avatar_url || "assaets/avatars/1.png";

          list.innerHTML += `
            <div class="row-item">
              <div class="row-left">
                <div class="medal">${medal}</div>
                <img class="row-avatar" src="${avatar}" alt="avatar">
                <div class="row-name">${nickname}</div>
              </div>
              <div class="row-score">${player.score} üçÖ</div>
            </div>
          `;
        });
      } catch (e) {
        list.innerHTML = "<p style='color:#ff5252; text-align:center;'>Reytingni yuklab bo'lmadi.</p>";
        console.error(e);
      }
    }

    // =========================
    // Coupons
    // =========================
    async function loadCoupons() {
      const identity = localStorage.getItem("tomama_identity");
      const wrap = document.getElementById("couponList");
      if (!wrap) return;

      wrap.innerHTML = "<p style='opacity:0.7'>Yuklanmoqda...</p>";

      try {
        const [catRes, myRes] = await Promise.all([
          fetch(`${SERVER_URL}/coupons`),
          identity ? fetch(`${SERVER_URL}/my/coupons?identity=${encodeURIComponent(identity)}`) : Promise.resolve(null)
        ]);

        const cat = await catRes.json();
        const my = myRes ? await myRes.json() : { ok: true, items: [] };
        if (!cat.ok) throw new Error("catalog_error");

        const diamonds = Number(localStorage.getItem("totalDiamonds") || 0);

        let html = `
          <div class="coupon-head">
            <div>
              <div class="coupon-head-title">Do‚Äòkon</div>
              <div class="coupon-head-sub">QR + Voucher Code sertifikat ko‚Äòrinishida beriladi</div>
            </div>
            <div class="diamond-badge">üíé ${diamonds}</div>
          </div>
        `;

        // Catalog
        cat.coupons.forEach(c => {
          const disabled = diamonds < Number(c.cost_diamonds);
          html += `
            <div class="coupon-card">
              <div class="coupon-card-top">
                <div class="coupon-card-title">${c.title}</div>
                <div class="coupon-card-cost">${c.cost_diamonds} üíé</div>
              </div>
              <div class="coupon-card-desc">${c.description || ""}</div>
              <button class="coupon-btn ${disabled ? "coupon-btn-disabled" : ""}"
                ${disabled ? "disabled" : ""} onclick="exchangeCoupon(${c.id})">
                ${disabled ? "üíé Yetarli emas" : "Almashtirish"}
              </button>
            </div>
          `;
        });

        // My coupons
        html += `<div class="divider"></div><div class="coupon-head-title">Mening kuponlarim</div>`;

        if (!identity) {
          html += `<p style="color:#ffb74d;opacity:0.95;font-size:13px;margin-top:10px;">
            Kuponlar ro‚Äòyxati uchun registratsiya kerak (guest ham bo‚Äòladi).
          </p>`;
        } else if (!my.ok || my.items.length === 0) {
          html += `<p style="opacity:0.75;color:#fff;margin-top:10px;">Hozircha kupon yo‚Äòq.</p>`;
        } else {
          my.items.forEach(it => {
            const st = (it.status || "active").toUpperCase();
            html += `
              <div class="coupon-card">
                <div class="coupon-card-top">
                  <div class="coupon-card-title">${it.title}</div>
                  <div class="coupon-status">${st}</div>
                </div>
                <div class="coupon-code">Voucher Code: <b>${it.voucher_code}</b></div>
                <button class="coupon-btn coupon-btn-ghost"
                  onclick="showCertificate('${it.voucher_code}', null, '${it.title}')">
                  Sertifikat
                </button>
              </div>
            `;
          });
        }

        wrap.innerHTML = html;
      } catch (e) {
        wrap.innerHTML = `<p style="color:#ff5252;">Kuponlarni yuklab bo‚Äòlmadi.</p>`;
        console.error(e);
      }
    }

    async function exchangeCoupon(couponId) {
      const identity = localStorage.getItem("tomama_identity");
      if (!identity) { alert("Avval registratsiya kerak."); return; }

      try {
        const res = await fetch(`${SERVER_URL}/coupons/exchange`, {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ identity, coupon_id: couponId })
        });
        const data = await res.json();

        if (!data.ok) {
          if (data.error === "NOT_ENOUGH_DIAMONDS") {
            alert(`üíé Yetarli emas. Kerak: ${data.need}, Sizda: ${data.have}`);
            return;
          }
          alert("Kupon olishda xatolik.");
          return;
        }

        if (typeof data.certificate?.diamonds_left === "number") {
          localStorage.setItem("totalDiamonds", String(data.certificate.diamonds_left));
          updateUIStats();
        }

        showCertificate(data.certificate.voucher_code, data.certificate.qr_data_url, data.certificate.title);
        loadCoupons();
      } catch (e) {
        console.error(e);
        alert("Server bilan aloqa yo‚Äòq.");
      }
    }

    function showCertificate(code, qrDataUrl, title) {
      let modal = document.getElementById("certModal");
      if (!modal) {
        modal = document.createElement("div");
        modal.id = "certModal";
        modal.className = "cert-overlay";
        modal.innerHTML = `
          <div class="cert-card">
            <div class="cert-top">
              <div>
                <div id="certTitle" class="cert-title"></div>
                <div class="cert-sub">Sertifikat (QR + Voucher Code)</div>
              </div>
              <button class="cert-close" onclick="document.getElementById('certModal').remove()">Yopish</button>
            </div>

            <div class="cert-body">
              <div class="cert-qr">
                <img id="certQR" src="" alt="qr">
              </div>
              <div class="cert-info">
                <div class="cert-label">Voucher Code</div>
                <div id="certCode" class="cert-code"></div>
                <button class="coupon-btn coupon-btn-ghost" onclick="navigator.clipboard?.writeText(document.getElementById('certCode').innerText)">
                  Koddan nusxa olish
                </button>
              </div>
            </div>

            <div class="cert-note">QR skan qilinsa kupon ‚ÄúUsed‚Äù bo‚Äòladi (bir martalik).</div>
          </div>
        `;
        document.body.appendChild(modal);
      } else {
        document.body.appendChild(modal);
      }

      document.getElementById("certTitle").innerText = title || "Kupon Sertifikati";
      document.getElementById("certCode").innerText = code || "";
      document.getElementById("certQR").src = qrDataUrl || "data:image/png;base64,iVBORw0KGgo=";
    }

    // =========================
    // Menu Functions
    // =========================
    async function startGame() {
      // game.js startGameLoop profil ready bo‚Äòlishini tekshiradi
      document.getElementById("mainMenu").classList.add("hidden");
      document.getElementById("gameCanvas").classList.remove("hidden");
      if (window.startGameLoop) await window.startGameLoop();
    }

    function showRanking() {
      tg?.BackButton.show();
      document.getElementById("mainMenu").classList.add("hidden");
      document.getElementById("rankingMenu").classList.remove("hidden");
      loadLeaderboard();
    }

    function showCoupons() {
      tg?.BackButton.show();
      document.getElementById("mainMenu").classList.add("hidden");
      document.getElementById("couponsMenu").classList.remove("hidden");
      loadCoupons();
    }

    function hideAllMenus() {
      tg?.BackButton.hide();
      document.querySelectorAll(".menu-container").forEach(m => m.classList.add("hidden"));
      document.getElementById("mainMenu").classList.remove("hidden");
      updateUIStats();
    }
  </script>

  <script src="game.js"></script>
</body>
</html>
